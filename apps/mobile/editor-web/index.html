<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Trace Editor</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        overflow-x: hidden;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      #root {
        min-height: 100%;
        height: 100%;
        width: 100%;
      }

      .ProseMirror {
        min-height: 100%;
        padding: 12px;
        padding-bottom: 100px;
        outline: none;
        cursor: text;
      }

      .ProseMirror:focus {
        outline: none;
      }

      /* Title styling */
      .ProseMirror h1.entry-title {
        font-size: 24px;
        font-weight: bold;
        margin: 0 0 12px 0;
        padding: 0 0 8px 0;
        border-bottom: 1px solid #e5e5e5;
        min-height: 1.4em;
      }

      /* Title placeholder */
      .ProseMirror h1.entry-title.is-empty::before {
        content: attr(data-placeholder);
        color: #9ca3af;
        pointer-events: none;
        height: 0;
        float: left;
      }

      /* Body placeholder (using Tiptap Placeholder extension classes) */
      .ProseMirror > p.is-empty.is-editor-empty:first-of-type::before,
      .ProseMirror > p.is-empty:first-of-type::before {
        content: attr(data-placeholder);
        color: #9ca3af;
        pointer-events: none;
        float: left;
        height: 0;
      }

      /* Dynamic height support for TenTap */
      .dynamic-height {
        overflow: visible;
      }
      .dynamic-height .ProseMirror {
        padding-bottom: 20px;
      }

      /* Ensure empty paragraphs have height */
      .ProseMirror p:empty::before {
        content: '';
        display: inline-block;
      }

      /* Clickable area after content */
      .ProseMirror::after {
        content: '';
        display: block;
        min-height: 200px;
        cursor: text;
      }

      /* Table styles */
      .ProseMirror table {
        border-collapse: collapse;
        width: auto;
        min-width: 100%;
        margin: 12px 0;
        display: block;
        overflow-x: auto;
        overscroll-behavior-x: contain;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-x pan-y;
      }
      .ProseMirror th,
      .ProseMirror td {
        border: 1px solid #d1d5db;
        padding: 8px;
        min-width: 60px;
        text-align: left;
        vertical-align: top;
        position: relative;
      }
      .ProseMirror th {
        background: #f3f4f6;
        font-weight: 600;
        white-space: nowrap;
      }
      .ProseMirror .selectedCell {
        background: #dbeafe;
      }
      .ProseMirror th.selectedCell {
        background: #bfdbfe;
      }
      /* Ensure paragraphs inside cells don't add extra margin */
      .ProseMirror th p,
      .ProseMirror td p {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script>
      // Forward console.log to React Native (must be before module script)
      (function() {
        var originalLog = console.log;
        var originalError = console.error;
        var originalWarn = console.warn;

        function sendToRN(level, args) {
          if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
            try {
              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: 'console',
                level: level,
                message: Array.from(args).map(function(a) {
                  return typeof a === 'object' ? JSON.stringify(a) : String(a);
                }).join(' ')
              }));
            } catch (e) {}
          }
        }

        console.log = function() {
          sendToRN('log', arguments);
          originalLog.apply(console, arguments);
        };
        console.error = function() {
          sendToRN('error', arguments);
          originalError.apply(console, arguments);
        };
        console.warn = function() {
          sendToRN('warn', arguments);
          originalWarn.apply(console, arguments);
        };
      })();
    </script>
    <script>
      // Notify React Native when user touches a table (for swipe-back gesture blocking)
      (function() {
        var tableActive = false;
        function isInsideTable(el) {
          while (el && el !== document.body) {
            if (el.tagName === 'TABLE' || el.tagName === 'TD' || el.tagName === 'TH') return true;
            el = el.parentElement;
          }
          return false;
        }
        function endTableTouch() {
          if (tableActive && window.ReactNativeWebView) {
            tableActive = false;
            window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'tableTouchEnd' }));
          }
        }
        document.addEventListener('touchstart', function(e) {
          if (isInsideTable(e.target) && window.ReactNativeWebView) {
            tableActive = true;
            window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'tableTouchStart' }));
          }
        }, { passive: true });
        document.addEventListener('touchend', endTableTouch, { passive: true });
        document.addEventListener('touchcancel', endTableTouch, { passive: true });
      })();
    </script>
    <script type="module" src="./index.tsx"></script>
  </body>
</html>
