import { useState, useMemo } from "react";
import { View, Text, StyleSheet, ScrollView, TouchableOpacity } from "react-native";
import { type Entry, isTaskOverdue, isDueToday, isDueThisWeek, getTaskStats } from "@trace/core";
import { useEntries } from "../modules/entries/mobileEntryHooks";
import { useNavigation } from "../shared/contexts/NavigationContext";
import { useNavigationMenu } from "../shared/hooks/useNavigationMenu";
import { TopBar } from "../components/layout/TopBar";
import { EntryListItem } from "../modules/entries/components/EntryListItem";

type TaskFilter = "all" | "incomplete" | "complete";
type TaskGroup = {
  title: string;
  entries: Entry[];
};

export function TasksScreen() {
  const { signOut } = useAuthState();
  const { navigate } = useNavigation();
  const { entries, isLoading, entryMutations } = useEntries();
  const [filter, setFilter] = useState<TaskFilter>("incomplete");

  const menuItems = [
    {
      label: "Inbox",
      onPress: () => navigate("inbox"),
      icon: (
        <Svg width={20} height={20} viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth={2}>
          <Path d="M22 12h-6l-2 3h-4l-2-3H2" strokeLinecap="round" strokeLinejoin="round" />
          <Path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z" strokeLinecap="round" strokeLinejoin="round" />
        </Svg>
      ),
    },
    {
      label: "Categories",
      onPress: () => navigate("categories"),
      icon: (
        <Svg width={20} height={20} viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth={2}>
          <Path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" strokeLinecap="round" strokeLinejoin="round" />
        </Svg>
      ),
    },
    {
      label: "Calendar",
      onPress: () => navigate("calendar"),
      icon: (
        <Svg width={20} height={20} viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth={2}>
          <Path d="M3 9h18M7 3v2m10-2v2" strokeLinecap="round" strokeLinejoin="round" />
          <Path d="M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z" strokeLinecap="round" strokeLinejoin="round" />
        </Svg>
      ),
    },
    {
      label: "Tasks",
      onPress: () => navigate("tasks"),
      icon: (
        <Svg width={20} height={20} viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth={2}>
          <Path d="M9 11l3 3L22 4" strokeLinecap="round" strokeLinejoin="round" />
          <Path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" strokeLinecap="round" strokeLinejoin="round" />
        </Svg>
      ),
    },
    { isDivider: true },
    {
      label: "ðŸ” Debug DB",
      onPress: () => navigate("debug"),
      icon: (
        <Svg width={20} height={20} viewBox="0 0 24 24" fill="none" stroke="#6b7280" strokeWidth={2}>
          <Path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" strokeLinecap="round" strokeLinejoin="round" />
        </Svg>
      ),
    },
    { isDivider: true },
    {
      label: "Sign Out",
      onPress: signOut,
      isSignOut: true,
      icon: (
        <Svg width={20} height={20} viewBox="0 0 24 24" fill="none" stroke="#ef4444" strokeWidth={2}>
          <Path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" strokeLinecap="round" strokeLinejoin="round" />
          <Path d="M16 17l5-5-5-5M21 12H9" strokeLinecap="round" strokeLinejoin="round" />
        </Svg>
      ),
    },
  ];

  // Filter entries to only tasks
  const tasks = useMemo(() => {
    return entries.filter(entry => entry.status === "incomplete" || entry.status === "complete");
  }, [entries]);

  // Get task statistics
  const stats = getTaskStats(tasks);

  // Filter tasks based on selected filter
  const filteredTasks = useMemo(() => {
    if (filter === "incomplete") {
      return tasks.filter(t => t.status === "incomplete");
    } else if (filter === "complete") {
      return tasks.filter(t => t.status === "complete");
    }
    return tasks;
  }, [tasks, filter]);

  // Group tasks by due date
  const taskGroups = useMemo((): TaskGroup[] => {
    const overdue: Entry[] = [];
    const today: Entry[] = [];
    const thisWeek: Entry[] = [];
    const noDueDate: Entry[] = [];
    const completed: Entry[] = [];

    filteredTasks.forEach(task => {
      if (task.status === "complete") {
        completed.push(task);
      } else if (isTaskOverdue(task.status, task.due_date)) {
        overdue.push(task);
      } else if (isDueToday(task.due_date)) {
        today.push(task);
      } else if (isDueThisWeek(task.due_date)) {
        thisWeek.push(task);
      } else {
        noDueDate.push(task);
      }
    });

    const groups: TaskGroup[] = [];

    if (overdue.length > 0) {
      groups.push({ title: "Overdue", entries: overdue });
    }
    if (today.length > 0) {
      groups.push({ title: "Today", entries: today });
    }
    if (thisWeek.length > 0) {
      groups.push({ title: "This Week", entries: thisWeek });
    }
    if (noDueDate.length > 0) {
      groups.push({ title: "No Due Date", entries: noDueDate });
    }
    if (completed.length > 0 && filter !== "incomplete") {
      groups.push({ title: "Completed", entries: completed });
    }

    return groups;
  }, [filteredTasks, filter]);

  // Handle task completion toggle
  const handleToggleComplete = async (entryId: string, currentStatus: "incomplete" | "complete") => {
    try {
      const newStatus = currentStatus === "complete" ? "incomplete" : "complete";
      await entryMutations.updateEntry(entryId, {
        status: newStatus,
      });
    } catch (error) {
      console.error("Failed to toggle task:", error);
    }
  };

  if (isLoading) {
    return (
      <View style={styles.container}>
        <TopBar
          title="Tasks"
          badge={stats.incomplete}
          menuItems={menuItems}
        />
        <View style={styles.loadingContainer}>
          <Text style={styles.loadingText}>Loading tasks...</Text>
        </View>
      </View>
    );
  }

  return (
    <View style={styles.container}>
      <TopBar
        title="Tasks"
        badge={stats.incomplete}
        menuItems={menuItems}
      />

      <ScrollView style={styles.content}>
        {/* Stats */}
        <View style={styles.stats}>
          <Text style={styles.statsText}>
            {stats.total} total â€¢ {stats.incomplete} incomplete â€¢ {stats.complete} completed
          </Text>
        </View>

        {/* Filter Tabs */}
        <View style={styles.filterContainer}>
          <TouchableOpacity
            style={[styles.filterTab, filter === "incomplete" && styles.filterTabActive]}
            onPress={() => setFilter("incomplete")}
            activeOpacity={0.7}
          >
            <Text style={[styles.filterTabText, filter === "incomplete" && styles.filterTabTextActive]}>
              Active ({stats.incomplete})
            </Text>
          </TouchableOpacity>

          <TouchableOpacity
            style={[styles.filterTab, filter === "complete" && styles.filterTabActive]}
            onPress={() => setFilter("complete")}
            activeOpacity={0.7}
          >
            <Text style={[styles.filterTabText, filter === "complete" && styles.filterTabTextActive]}>
              Completed ({stats.complete})
            </Text>
          </TouchableOpacity>

          <TouchableOpacity
            style={[styles.filterTab, filter === "all" && styles.filterTabActive]}
            onPress={() => setFilter("all")}
            activeOpacity={0.7}
          >
            <Text style={[styles.filterTabText, filter === "all" && styles.filterTabTextActive]}>
              All ({stats.total})
            </Text>
          </TouchableOpacity>
        </View>

        {/* Task Groups or Empty State */}
        {taskGroups.length === 0 ? (
          <View style={styles.emptyState}>
            <Text style={styles.emptyIcon}>âœ“</Text>
            <Text style={styles.emptyTitle}>No tasks yet</Text>
            <Text style={styles.emptyDescription}>
              Create a new entry and mark it as a task to get started
            </Text>
            <TouchableOpacity
              style={styles.emptyButton}
              onPress={() => navigate("capture")}
              activeOpacity={0.7}
            >
              <Text style={styles.emptyButtonText}>Create Task</Text>
            </TouchableOpacity>
          </View>
        ) : (
          <View style={styles.groupsContainer}>
            {taskGroups.map((group) => (
              <View key={group.title} style={styles.group}>
                {/* Group Header */}
                <View style={styles.groupHeader}>
                  <Text style={styles.groupTitle}>{group.title}</Text>
                  <Text style={styles.groupCount}>({group.entries.length})</Text>
                </View>

                {/* Group Entries */}
                {group.entries.map((entry) => (
                  <EntryListItem
                    key={entry.entry_id}
                    entry={entry}
                    onPress={() => navigate("capture", { entryId: entry.entry_id })}
                    onToggleComplete={handleToggleComplete}
                  />
                ))}
              </View>
            ))}
          </View>
        )}
      </ScrollView>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: "#f9fafb",
  },
  content: {
    flex: 1,
    padding: 20,
  },
  loadingContainer: {
    flex: 1,
    alignItems: "center",
    justifyContent: "center",
  },
  loadingText: {
    fontSize: 16,
    color: "#6b7280",
  },
  stats: {
    marginBottom: 16,
  },
  statsText: {
    fontSize: 14,
    color: "#6b7280",
  },
  filterContainer: {
    flexDirection: "row",
    backgroundColor: "#e5e7eb",
    borderRadius: 8,
    padding: 4,
    marginBottom: 20,
  },
  filterTab: {
    flex: 1,
    paddingVertical: 8,
    paddingHorizontal: 12,
    borderRadius: 6,
    alignItems: "center",
  },
  filterTabActive: {
    backgroundColor: "#ffffff",
    shadowColor: "#000",
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.05,
    shadowRadius: 1,
    elevation: 1,
  },
  filterTabText: {
    fontSize: 14,
    fontWeight: "500",
    color: "#6b7280",
  },
  filterTabTextActive: {
    color: "#111827",
  },
  groupsContainer: {
    paddingBottom: 20,
  },
  group: {
    marginBottom: 24,
  },
  groupHeader: {
    flexDirection: "row",
    alignItems: "center",
    marginBottom: 12,
  },
  groupTitle: {
    fontSize: 18,
    fontWeight: "600",
    color: "#111827",
  },
  groupCount: {
    fontSize: 14,
    color: "#6b7280",
    marginLeft: 8,
  },
  emptyState: {
    alignItems: "center",
    paddingVertical: 60,
    paddingHorizontal: 20,
  },
  emptyIcon: {
    fontSize: 64,
    marginBottom: 16,
  },
  emptyTitle: {
    fontSize: 18,
    fontWeight: "600",
    color: "#1a1a1a",
    marginBottom: 8,
  },
  emptyDescription: {
    fontSize: 14,
    color: "#6b7280",
    textAlign: "center",
    marginBottom: 20,
  },
  emptyButton: {
    backgroundColor: "#3b82f6",
    paddingVertical: 12,
    paddingHorizontal: 24,
    borderRadius: 8,
  },
  emptyButtonText: {
    color: "#ffffff",
    fontSize: 16,
    fontWeight: "600",
  },
});
